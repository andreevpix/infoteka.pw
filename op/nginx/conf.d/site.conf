
    upstream php {
            server unix:/var/run/php5-fpm.sock;
    }
    server {
        listen              443 ssl http2;
        root /srv/infoteka.pw;
        server_name         infoteka.pw;
        index index.php index.html index.htm;
        
        set $skip_cache 0;
        set $cache_uri $request_uri;

        location / {
            index index.php;
            try_files $uri $uri/ /index.php?$args;
        }
        
        location ~ [^/]\.php(/|$) {
            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
         fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
         fastcgi_cache_bypass $skip_cache;
         fastcgi_no_cache $skip_cache;
         fastcgi_cache WORDPRESS;
         fastcgi_cache_use_stale updating;
         fastcgi_cache_bypass $http_pragma;
         fastcgi_cache_methods GET HEAD;
         fastcgi_buffer_size 128k;
         fastcgi_keep_conn on;
         fastcgi_buffers 256 16k;
         fastcgi_busy_buffers_size 256k;
         fastcgi_temp_file_write_size 256k;
         if_modified_since before;
         fastcgi_cache_min_uses 3;
         try_files $uri /index.php;
         include fastcgi_params;
         fastcgi_pass php;
         fastcgi_index index.php;
        }
        location ~* \.(?:rss|atom)$ {
            expires 1h;
        }
        location ~ /\.(?!well-known\/) {
            deny all;
        }
        location ~* (?:\.(?:bak|conf|dist|fla|in[ci]|log|orig|psd|sh|sql|sw[op])|~)$ {
            deny all;
        }
        location ~* (.+)\.(?:\w+)\.(bmp|css|cur|gif|ico|jpe?g|m?js|png|svgz?|webp|webmanifest)$ {
            try_files $uri $1.$2;
        }
        location ~* \.(?:ttf|ttc|otf|eot|woff|woff2)$ {
            expires         1M;
            add_header      Cache-Control "public";
        }
        location ~* \.(?:css|js|txt)$ {
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }
        location ~* \.svgz$ {
            access_log off;
            gzip off;
            expires 1M;
        }
        location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|mp4|ogg|ogv|webm|htc)$ {
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public";
            access_log off;
            expires 1M;
            log_not_found off;
        }
        location = /favicon.ico {
                    log_not_found off;
                    access_log off;
        }
        location = /robots.txt {
                    allow all;
                    try_files $uri $uri/ /index.php?$args @robots;
                    log_not_found off;
                    access_log off;
        }
        location @robots {
            return 200 "User-agent: *\nDisallow: /wp-admin/\nAllow: /wp-admin/admin-ajax.php\n";
        }
        location ~ /\. {
                    deny all; # запрет для скрытых файлов
        }
        location /wp-content/uploads {
            location ~ \.php$ {
                deny all;
            }
        }
        location ~* /(?:uploads|files)/.*\.php$ {
            deny all;
        }
        location = /wp-config.php {
            deny all;
            log_not_found off;
            access_log off;
        }
        
        charset off;

        error_page 403 = 404;

        ###WORDPRESS###
        if ($request_method = POST) {
            set $cache_uri 'null cache';
        }
        if ($query_string != "") {
            set $cache_uri 'null cache';
        }

        # Don't cache uris containing the following segments
        if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
            set $cache_uri 'null cache';
        }

        # Don't use the cache for logged in users or recent commenters
        if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
            set $cache_uri 'null cache';
        }

    
    ssl_certificate /etc/letsencrypt/live/infoteka.pw-0001/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/infoteka.pw-0001/privkey.pem; # managed by Certbot
}